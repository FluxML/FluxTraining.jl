{"attributes":{"backlinks":[{"tag":"document","title":"Getting started","docid":"documents/docs/overview.md"},{"tag":"document","title":"Features","docid":"documents/docs/features.md"},{"tag":"document","title":"FluxTraining.jl","docid":"documents/README.md"},{"tag":"documentation","title":"Scheduler","docid":"references/FluxTraining.Scheduler"}],"path":"/home/runner/.julia/packages/FluxTraining/YVIq2/docs/tutorials/hyperparameters.md","title":"Hyperparameter scheduling"},"tag":"document","children":[{"attributes":{},"tag":"md","children":[{"attributes":{},"tag":"h1","children":["Hyperparameter scheduling"],"type":"node"},{"attributes":{},"tag":"p","children":["When training neural networks, you often have to tune hyperparameters."],"type":"node"},{"attributes":{},"tag":"p","children":["In ",{"attributes":{},"tag":"em","children":["FluxTraining",".","jl"],"type":"node"}," the following definition is used:"],"type":"node"},{"attributes":{},"tag":"blockquote","children":[{"attributes":{},"tag":"p","children":[{"attributes":{},"tag":"em","children":["A hyperparameter is any state that influences the training and is not a parameter of the model","."],"type":"node"}],"type":"node"}],"type":"node"},{"attributes":{},"tag":"p","children":["Common hyperparameters to worry about are the learning rate, batch size and regularization strength."],"type":"node"},{"attributes":{},"tag":"p","children":["In recent years, it has also become common practice to schedule some hyperparameters. The cyclical learning rate schedule introduced in ",{"attributes":{"href":"https://arxiv.org/abs/1506.01186","title":""},"tag":"a","children":["L","."," Smith 2015"],"type":"node"},", for example, changes the learning rate every step to speed up convergence."],"type":"node"},{"attributes":{},"tag":"p","children":[{"attributes":{},"tag":"em","children":["FluxTraining",".","jl"],"type":"node"}," provides an extensible interface for hyperparameter scheduling that is not restricted to optimizer hyperparameters as in many other training frameworks. To use it, you have to create a ",{"attributes":{"reftype":"symbol","document_id":"references/FluxTraining.Scheduler"},"tag":"reference","children":[{"attributes":{},"tag":"code","children":["Scheduler"],"type":"node"}],"type":"node"},", a callback that can be passed to a ",{"attributes":{"reftype":"symbol","document_id":"references/FluxTraining.Learner"},"tag":"reference","children":[{"attributes":{},"tag":"code","children":["Learner"],"type":"node"}],"type":"node"},"."],"type":"node"},{"attributes":{},"tag":"p","children":[{"attributes":{},"tag":"code","children":["Scheduler"],"type":"node"},"’s constructor takes pairs of hyperparameter types and associated schedules."],"type":"node"},{"attributes":{},"tag":"p","children":["As an example"],"type":"node"},{"attributes":{},"tag":"ul","children":[{"attributes":{},"tag":"li","children":[{"attributes":{},"tag":"p","children":[{"attributes":{"reftype":"symbol","document_id":"references/FluxTraining.LearningRate"},"tag":"reference","children":[{"attributes":{},"tag":"code","children":["LearningRate"],"type":"node"}],"type":"node"}," is a hyperparameter type representing the optimizer’s step size; and"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"li","children":[{"attributes":{},"tag":"p","children":[{"attributes":{},"tag":"code","children":["schedule = Exp(γ=0.9)"],"type":"node"}," represents an exponential decay scheduling"],"type":"node"}],"type":"node"}],"type":"node"},{"attributes":{},"tag":"p","children":["We can create the callback scheduling the learning rate according to ",{"attributes":{},"tag":"code","children":["Scheduler(LearningRate => schedule)"],"type":"node"},"."],"type":"node"},{"attributes":{},"tag":"p","children":[{"attributes":{},"tag":"code","children":["Schedule"],"type":"node"},"s are built around ",{"attributes":{"href":"https://darsnack.github.io/ParameterSchedulers.jl/dev/","title":""},"tag":"a","children":[{"attributes":{},"tag":"em","children":["ParameterSchedulers",".","jl"],"type":"node"}],"type":"node"},". See that package’s documentation for more details on how to construct them."],"type":"node"},{"attributes":{},"tag":"h3","children":["One","-","cycle learning rate"],"type":"node"},{"attributes":{},"tag":"p","children":["Let’s define a ",{"attributes":{},"tag":"code","children":["Schedule"],"type":"node"}," that follows the above-mentioned cyclical learning rate schedule."],"type":"node"},{"attributes":{},"tag":"p","children":["The idea is to start with a small learning rate, gradually increase it, and then slowly decrease it again."],"type":"node"},{"attributes":{},"tag":"p","children":["For example, we could start with a learning rate of 0.01, increase it to 0.1 over 3 epochs, and then down to 0.001 over 7 epochs. Let’s also use cosine annealing, a common practice that makes sure the values are interpolated more smoothly."],"type":"node"},{"attributes":{},"tag":"p","children":["In code, that looks like this:"],"type":"node"},{"attributes":{"lang":"julia"},"tag":"codeblock","children":[{"attributes":{},"tag":"julia","children":[{"attributes":{},"tag":"USING","children":[{"attributes":{},"tag":"COLON","children":[{"attributes":{},"tag":"USING","children":["using"],"type":"node"},{"attributes":{},"tag":"DOT","children":[{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["ParameterSchedulers"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"COLON","children":[":"],"type":"node"},{"attributes":{},"tag":"DOT","children":[{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["Shifted"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"COMMA","children":[","],"type":"node"},{"attributes":{},"tag":"DOT","children":[{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["Sin"],"type":"node"}],"type":"node"}],"type":"node"}],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":["  "],"type":"node"},{"attributes":{},"tag":"COMMENT","children":["# for cosine annealing"],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n"],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n"],"type":"node"},{"attributes":{},"tag":"EQ","children":[{"attributes":{},"tag":"IDENTIFIER","children":["es"],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"EQ","children":["="],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"IDENTIFIER","children":["length"],"type":"node"},{"attributes":{},"tag":"LPAREN","children":["("],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["traindl"],"type":"node"},{"attributes":{},"tag":"RPAREN","children":[")"],"type":"node"}],"type":"node"}],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":["     "],"type":"node"},{"attributes":{},"tag":"COMMENT","children":["# number of steps in an epoch"],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n"],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n"],"type":"node"},{"attributes":{},"tag":"EQ","children":[{"attributes":{},"tag":"IDENTIFIER","children":["schedule"],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"EQ","children":["="],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"IDENTIFIER","children":["Sequence"],"type":"node"},{"attributes":{},"tag":"LPAREN","children":["("],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n    "],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"IDENTIFIER","children":["Sin"],"type":"node"},{"attributes":{},"tag":"LPAREN","children":["("],"type":"node"},{"attributes":{},"tag":"KW","children":[{"attributes":{},"tag":"IDENTIFIER","children":["λ0"],"type":"node"},{"attributes":{},"tag":"EQ","children":["="],"type":"node"},{"attributes":{},"tag":"FLOAT","children":["0.01"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"COMMA","children":[","],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"COMMENT","children":["# initial learning rate"],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n        "],"type":"node"},{"attributes":{},"tag":"KW","children":[{"attributes":{},"tag":"IDENTIFIER","children":["λ1"],"type":"node"},{"attributes":{},"tag":"EQ","children":["="],"type":"node"},{"attributes":{},"tag":"FLOAT","children":["0.1"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"COMMA","children":[","],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"COMMENT","children":["# max learning rate"],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n        "],"type":"node"},{"attributes":{},"tag":"KW","children":[{"attributes":{},"tag":"IDENTIFIER","children":["period"],"type":"node"},{"attributes":{},"tag":"EQ","children":["="],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"INTEGER","children":["2"],"type":"node"},{"attributes":{},"tag":"STAR","children":["*"],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"INTEGER","children":["3"],"type":"node"},{"attributes":{},"tag":"STAR","children":[""],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["es"],"type":"node"}],"type":"node"}],"type":"node"}],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"COMMENT","children":["#"],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n        "],"type":"node"},{"attributes":{},"tag":"RPAREN","children":[")"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"PAIR_ARROW","children":["=>"],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"INTEGER","children":["3"],"type":"node"},{"attributes":{},"tag":"STAR","children":[""],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["es"],"type":"node"}],"type":"node"}],"type":"node"},{"attributes":{},"tag":"COMMA","children":[","],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n    "],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"IDENTIFIER","children":["Shifted"],"type":"node"},{"attributes":{},"tag":"LPAREN","children":["("],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n        "],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"IDENTIFIER","children":["Sin"],"type":"node"},{"attributes":{},"tag":"LPAREN","children":["("],"type":"node"},{"attributes":{},"tag":"KW","children":[{"attributes":{},"tag":"IDENTIFIER","children":["λ0"],"type":"node"},{"attributes":{},"tag":"EQ","children":["="],"type":"node"},{"attributes":{},"tag":"FLOAT","children":["0.1"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"COMMA","children":[","],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"COMMENT","children":["# max learning rate"],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n            "],"type":"node"},{"attributes":{},"tag":"KW","children":[{"attributes":{},"tag":"IDENTIFIER","children":["λ1"],"type":"node"},{"attributes":{},"tag":"EQ","children":["="],"type":"node"},{"attributes":{},"tag":"FLOAT","children":["0.001"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"COMMA","children":[","],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"COMMENT","children":["# end learning rate"],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n            "],"type":"node"},{"attributes":{},"tag":"KW","children":[{"attributes":{},"tag":"IDENTIFIER","children":["period"],"type":"node"},{"attributes":{},"tag":"EQ","children":["="],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"INTEGER","children":["2"],"type":"node"},{"attributes":{},"tag":"STAR","children":["*"],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"INTEGER","children":["7"],"type":"node"},{"attributes":{},"tag":"STAR","children":[""],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["es"],"type":"node"}],"type":"node"}],"type":"node"}],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":[" \n        "],"type":"node"},{"attributes":{},"tag":"RPAREN","children":[")"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"COMMA","children":[","],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"INTEGER","children":["7"],"type":"node"},{"attributes":{},"tag":"STAR","children":[""],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["es"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"PLUS","children":["+"],"type":"node"},{"attributes":{},"tag":"INTEGER","children":["1"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n    "],"type":"node"},{"attributes":{},"tag":"RPAREN","children":[")"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"PAIR_ARROW","children":["=>"],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"INTEGER","children":["7"],"type":"node"},{"attributes":{},"tag":"STAR","children":[""],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["es"],"type":"node"}],"type":"node"}],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n"],"type":"node"},{"attributes":{},"tag":"RPAREN","children":[")"],"type":"node"}],"type":"node"}],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n"],"type":"node"},{"attributes":{},"tag":"NEWLINE_WS","children":["\n"],"type":"node"},{"attributes":{},"tag":"EQ","children":[{"attributes":{},"tag":"IDENTIFIER","children":["learner"],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"EQ","children":["="],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{},"tag":"IDENTIFIER","children":["model"],"type":"node"},{"attributes":{},"tag":"LPAREN","children":["("],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["model"],"type":"node"},{"attributes":{},"tag":"COMMA","children":[","],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["data"],"type":"node"},{"attributes":{},"tag":"COMMA","children":[","],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["opt"],"type":"node"},{"attributes":{},"tag":"COMMA","children":[","],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["lossfn"],"type":"node"},{"attributes":{},"tag":"COMMA","children":[","],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{"reftype":"symbol","document_id":"references/FluxTraining.Scheduler"},"tag":"reference","children":["Scheduler"],"type":"node"},{"attributes":{},"tag":"LPAREN","children":["("],"type":"node"},{"attributes":{},"tag":"CALL","children":[{"attributes":{"reftype":"symbol","document_id":"references/FluxTraining.LearningRate"},"tag":"reference","children":["LearningRate"],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"PAIR_ARROW","children":["=>"],"type":"node"},{"attributes":{},"tag":"WHITESPACE","children":[" "],"type":"node"},{"attributes":{},"tag":"IDENTIFIER","children":["schedule"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"RPAREN","children":[")"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"RPAREN","children":[")"],"type":"node"}],"type":"node"}],"type":"node"}],"type":"node"}],"type":"node"},{"attributes":{},"tag":"p","children":["For convenience, you can also use the ",{"attributes":{"reftype":"symbol","document_id":"references/FluxTraining.onecycle"},"tag":"reference","children":[{"attributes":{},"tag":"code","children":["onecycle"],"type":"node"}],"type":"node"}," helper to create this ",{"attributes":{},"tag":"code","children":["Schedule"],"type":"node"},".",{"attributes":{},"tag":"br","children":[],"type":"node"},"See ",{"attributes":{"href":"https://darsnack.github.io/ParameterSchedulers.jl/dev/docs/tutorials/warmup-schedules.html","title":""},"tag":"a","children":["ParameterSchedulers",".","jl documentation"],"type":"node"}," for more details on warm-up schedules."],"type":"node"},{"attributes":{},"tag":"h2","children":["Extending"],"type":"node"},{"attributes":{},"tag":"p","children":["You can create and schedule your own hyperparameters."],"type":"node"},{"attributes":{},"tag":"p","children":["To do this, you will need to define"],"type":"node"},{"attributes":{},"tag":"ul","children":[{"attributes":{},"tag":"li","children":[{"attributes":{},"tag":"p","children":["a type for your hyperparameter, e.g. ",{"attributes":{},"tag":"code","children":["abstract type MyParam <: HyperParameter end"],"type":"node"},","],"type":"node"}],"type":"node"},{"attributes":{},"tag":"li","children":[{"attributes":{},"tag":"p","children":["how to set the hyperparameter by implementing ",{"attributes":{"reftype":"symbol","document_id":"references/FluxTraining.sethyperparameter!"},"tag":"reference","children":[{"attributes":{},"tag":"code","children":["sethyperparameter!"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"code","children":["(learner, ::Type{MyParam}, value)"],"type":"node"}],"type":"node"}],"type":"node"},{"attributes":{},"tag":"li","children":[{"attributes":{},"tag":"p","children":["what state needs to be accessed to set the hyperparameter by implementing ",{"attributes":{"reftype":"symbol","document_id":"references/FluxTraining.stateaccess"},"tag":"reference","children":[{"attributes":{},"tag":"code","children":["stateaccess"],"type":"node"}],"type":"node"},{"attributes":{},"tag":"code","children":["(::Type{MyParam})"],"type":"node"},". See ",{"attributes":{"reftype":"document","href":"../callbacks/custom.md","title":"","document_id":"documents/docs/callbacks/custom.md"},"tag":"reference","children":["custom callbacks"],"type":"node"}," for more info on why this is needed."],"type":"node"}],"type":"node"}],"type":"node"},{"attributes":{"class":"info"},"tag":"admonition","children":[{"attributes":{},"tag":"admonitiontitle","children":["Kinds of hyperparameters"],"type":"node"},{"attributes":{},"tag":"admonitionbody","children":[{"attributes":{},"tag":"p","children":["Hyperparameters don’t need to belong to the optimizer! For example, you could create a hyperparameter for batch size. That is not implemented here because this package is agnostic of the data iterators and the implementation would differ for every type of iterator."],"type":"node"}],"type":"node"}],"type":"node"}],"type":"node"}],"type":"node"}